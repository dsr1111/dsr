<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="https://media.dsrwiki.com/dsrwiki/icon.webp" type="image/x-icon" />
    <title>가챠 시뮬레이터 | DSR WIKI</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <link rel="stylesheet" href="assets/css/styles1.css" />
    <script src="app/lazyload.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="app/nav.js" defer></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V5VLCXSKM7"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6625279423156068"
     crossorigin="anonymous"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-V5VLCXSKM7');
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              header: 'hsl(220, 24%, 18%)',
            }
          }
        }
      }
    </script>
    <link rel="stylesheet" href="web/static/pretendard.css">
    <style>
      .box-open-container {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      @media (max-width: 768px) {
        .box-open-container {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
          padding: 15px;
        }
        .box-image-container {
          width: 60px;
          height: 60px;
          margin: 0 auto;
        }
        .box-info {
          text-align: center;
        }
        .box-controls {
          justify-content: center;
        }
      }
      .box-image-container {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #0a0e1a;
        border-radius: 8px;
        border: 1px solid #0a0e1a;
        flex-shrink: 0;
      }
      .box-image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .box-image-placeholder {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        text-align: center;
        padding: 5px;
      }
      .box-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .box-info-name {
        font-size: 20px;
        font-weight: bold;
        color: #333;
      }
      .box-info-description {
        font-size: 14px;
        color: #666;
      }
      .box-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .console-container {
        background-color: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        font-family: "Isamanru", sans-serif;
        color: #d4d4d4;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        max-height: 500px;
      }
      .console-content-wrapper {
        overflow-y: auto;
        flex: 1;
        min-height: 0;
        scrollbar-width: thin;
        scrollbar-color: #3e3e3e #1e1e1e;
      }
      .console-content-wrapper::-webkit-scrollbar {
        width: 8px;
      }
      .console-content-wrapper::-webkit-scrollbar-track {
        background: #1e1e1e;
        border-radius: 4px;
      }
      .console-content-wrapper::-webkit-scrollbar-thumb {
        background: #3e3e3e;
        border-radius: 4px;
      }
      .console-content-wrapper::-webkit-scrollbar-thumb:hover {
        background: #4e4e4e;
      }
      @font-face {
        font-family: 'Isamanru';
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.0/GongGothicMedium.woff') format('woff');
        font-weight: normal;
        font-display: swap;
      }
      .console-header {
        color: #4ec9b0;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 14px;
        border-bottom: 1px solid #3e3e3e;
        padding-bottom: 10px;
      }
      .console-footer {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 15px;
        margin-top: 10px;
        flex-shrink: 0;
        flex-wrap: wrap;
      }
      @media (max-width: 768px) {
        .console-footer {
          gap: 10px;
          font-size: 14px;
        }
        .clear-btn {
          font-size: 14px;
          padding: 8px 12px;
        }
        .counter-display {
          font-size: 14px;
        }
      }
      .console-line {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
        word-wrap: break-word;
      }
      .console-line.rare-item {
        animation: rareItemEffect 1s ease-in-out;
        background: linear-gradient(90deg, rgba(136, 23, 206, 0.1) 0%, rgba(54, 154, 230, 0.1) 50%, rgba(136, 23, 206, 0.1) 100%);
        background-size: 200% 100%;
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 3px solid #8817CE;
      }
      @keyframes rareItemEffect {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 rgba(136, 23, 206, 0);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 15px rgba(136, 23, 206, 0.5);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 rgba(136, 23, 206, 0);
        }
      }
      .console-line.rare-item .item-grade-4 {
        text-shadow: 0 0 8px rgba(136, 23, 206, 0.8);
        font-weight: bold;
      }
      .console-line .timestamp {
        color: #808080;
        margin-right: 10px;
      }
      .console-line .log-number {
        color: #808080;
        margin-right: 10px;
        font-weight: bold;
        display: inline-block;
        min-width: 45px;
        text-align: right;
      }
      .console-line .item-name {
        color: #4ec9b0;
      }
      .item-grade-1 {
        color: #9CA4A8; /* 1등급 */
      }
      .item-grade-2 {
        color: #14D35A; /* 2등급 */
      }
      .item-grade-3 {
        color: #369AE6; /* 3등급 */
      }
      .item-grade-4 {
        color: #8817CE; /* 4등급 */
      }
      .console-line .item-count {
        color: #d4d4d4;
        font-weight: bold;
      }
      .trade-available {
        color: #90ee90; /* 연두색 - 거래가능 */
      }
      .trade-unavailable {
        color: #f48771; /* 빨간색 - 거래불가 */
      }
      .clear-btn {
        background-color: #3e3e3e;
        color: #d4d4d4;
        border: 1px solid #555;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 0;
        transition: background-color 0.2s;
      }
      .clear-btn:hover {
        background-color: #4e4e4e;
      }
      .gacha-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .count-controls {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .count-btn {
        width: 35px;
        height: 35px;
        background-color: hsl(220, 24%, 15%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }
      .count-btn:hover {
        background-color: hsl(220, 24%, 20%);
      }
      .count-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .count-input {
        width: 70px;
        height: 35px;
        padding: 0 8px;
        border: 2px solid hsl(220, 24%, 15%);
        border-radius: 6px;
        font-size: 16px;
        text-align: center;
        font-weight: bold;
        -moz-appearance: textfield;
        appearance: textfield;
      }
      .count-input::-webkit-outer-spin-button,
      .count-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .open-btn {
        height: 35px;
        background-color: hsl(220, 24%, 15%);
        color: white;
        border: none;
        padding: 0 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }
      .open-btn:hover {
        background-color: hsl(220, 24%, 20%);
      }
      .open-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .counter-display {
        background-color: #3e3e3e;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: normal;
        color: #d4d4d4;
        border: 1px solid #555;
        height: fit-content;
      }
      .counter-label {
        color: #9cdcfe;
        margin-right: 6px;
      }
      .stats-btn {
        background-color: #3e3e3e;
        color: #d4d4d4;
        border: 1px solid #555;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 0;
        transition: background-color 0.2s;
        font-weight: normal;
      }
      .stats-btn:hover {
        background-color: #4e4e4e;
      }
      /* 통계 모달 스타일 */
      .stats-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .stats-modal-content {
        background-color: #1e1e1e;
        border-radius: 8px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }
      .stats-modal-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #3e3e3e;
      }
      .stats-modal-header h2 {
        color: #d4d4d4;
        margin: 0;
        font-size: 20px;
        font-weight: bold;
      }
      .stats-modal-close {
        background: none;
        border: none;
        color: #d4d4d4;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
      }
      .stats-modal-close:hover {
        color: #fff;
      }
      .stats-modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
        scrollbar-width: thin;
        scrollbar-color: #3e3e3e #1e1e1e;
      }
      .stats-modal-body::-webkit-scrollbar {
        width: 8px;
      }
      .stats-modal-body::-webkit-scrollbar-track {
        background: #1e1e1e;
        border-radius: 4px;
      }
      .stats-modal-body::-webkit-scrollbar-thumb {
        background: #3e3e3e;
        border-radius: 4px;
      }
      .stats-modal-body::-webkit-scrollbar-thumb:hover {
        background: #4e4e4e;
      }
      .stats-section {
        margin-bottom: 25px;
      }
      .stats-section-title {
        color: #4ec9b0;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #3e3e3e;
      }
      .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stats-summary-item {
        background-color: #2e2e2e;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #3e3e3e;
      }
      .stats-summary-label {
        color: #9cdcfe;
        font-size: 12px;
        margin-bottom: 5px;
      }
      .stats-summary-value {
        color: #d4d4d4;
        font-size: 18px;
        font-weight: bold;
      }
      .stats-item-list {
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #3e3e3e #1e1e1e;
      }
      .stats-item-list::-webkit-scrollbar {
        width: 6px;
      }
      .stats-item-list::-webkit-scrollbar-track {
        background: #1e1e1e;
      }
      .stats-item-list::-webkit-scrollbar-thumb {
        background: #3e3e3e;
        border-radius: 3px;
      }
      .stats-item-row {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #2e2e2e;
        gap: 15px;
      }
      .stats-item-row:last-child {
        border-bottom: none;
      }
      .stats-item-name {
        flex: 1;
        font-size: 14px;
      }
      .stats-item-count {
        color: #d4d4d4;
        font-weight: bold;
        min-width: 60px;
        text-align: right;
      }
      .stats-item-percentage {
        color: #9cdcfe;
        font-size: 12px;
        min-width: 80px;
        text-align: right;
      }
      @media (max-width: 768px) {
        .stats-modal-content {
          max-width: 100%;
          max-height: 95vh;
        }
        .stats-modal-header {
          padding: 15px;
        }
        .stats-modal-body {
          padding: 15px;
        }
        .stats-summary {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }
        .stats-item-row {
          flex-wrap: wrap;
          gap: 8px;
        }
        .stats-item-name {
          width: 100%;
        }
        .stats-item-count,
        .stats-item-percentage {
          min-width: auto;
        }
      }
      .box-selector {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .box-selector select {
        border: 1px solid #ddd;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body class="bg-[#f4f4f9] font-['Pretendard']">
    <custom-nav></custom-nav>
    
    <!-- 우측 사이드 레일 광고 -->
    <ins class="adsbygoogle"
         style="display:block; position:fixed; top:50%; right:10px; width:160px; height:600px; transform:translateY(-50%); z-index:1000;"
         data-ad-client="ca-pub-6625279423156068"
         data-ad-slot="1851169108"
         data-ad-format="auto"
         data-full-width-responsive="false">
    </ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    
    <!-- 좌측 사이드 레일 광고 -->
    <ins class="adsbygoogle"
         style="display:block; position:fixed; top:50%; left:10px; width:160px; height:600px; transform:translateY(-50%); z-index:1000;"
         data-ad-client="ca-pub-6625279423156068"
         data-ad-slot="1428393398"
         data-ad-format="auto"
         data-full-width-responsive="false">
    </ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    
    <!-- 모바일에서 사이드 광고 숨김 -->
    <style>
      @media (max-width: 1370px) {
        .adsbygoogle[data-ad-slot="1428393398"],
        .adsbygoogle[data-ad-slot="1851169108"] {
          display: none !important;
        }
      }
    </style>
    
    <div class="mt-[80px] md:mt-[100px] pb-16 md:pb-12">
      <div class="w-[90%] max-w-[1000px] mx-auto mt-8 md:mt-12">
        <div class="bg-white p-5 rounded-lg shadow-md">
          <!-- 상자 선택 -->
          <div class="box-selector">
            <select id="box-select">
              <option value="">상자를 선택하세요...</option>
            </select>
          </div>
          
          <!-- 상자 열기 영역 -->
          <div class="box-open-container" id="box-open-container" style="opacity: 0.5; pointer-events: none;">
            <div class="box-image-container">
              <div class="box-image-placeholder" id="box-image-placeholder">상자</div>
              <img id="box-image" src="" alt="상자 이미지" style="display: none;">
            </div>
            <div class="box-info">
              <div class="box-info-name" id="box-name">상자를 선택하세요</div>
              <div class="box-info-description" id="box-description">위에서 상자를 선택해주세요</div>
            </div>
            <div class="box-controls">
              <div class="count-controls">
                <button class="count-btn" id="count-minus-btn">-</button>
                <input type="number" id="gacha-count" class="count-input" value="1" min="1" max="1000">
                <button class="count-btn" id="count-plus-btn">+</button>
              </div>
              <button class="open-btn" id="open-btn">개봉</button>
            </div>
          </div>
          
          <!-- 콘솔 영역 -->
          <div class="console-container">
            <div class="console-header">가챠 결과 로그</div>
            <div class="console-content-wrapper">
              <div id="console-content">
              </div>
            </div>
            <div class="console-footer">
              <button class="clear-btn" id="clear-btn">로그 지우기</button>
              <button class="stats-btn" id="stats-btn">통계 보기</button>
              <div class="counter-display">
                <span class="counter-label">총 개봉 횟수:</span>
                <span id="total-count">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 통계 모달 -->
    <div id="stats-modal" class="stats-modal-overlay" style="display: none;">
      <div class="stats-modal-content">
        <div class="stats-modal-header">
          <button class="stats-modal-close" id="stats-modal-close">&times;</button>
        </div>
        <div class="stats-modal-body" id="stats-modal-body">
          <!-- 통계 내용이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>
    </div>


    <script>
      // 가챠 데이터
      let gachaData = null;
      let currentBox = null;
      let gachaItems = [];

      // 로그 통계 데이터
      let logStats = {
        totalOpens: 0,
        items: {}, // { "아이템명": { count: 횟수, grade: 등급, probability: 확률 } }
        grades: { 1: 0, 2: 0, 3: 0, 4: 0 },
        tradeable: { available: 0, unavailable: 0 },
        rareItems: 0 // 확률 0.5% 미만 아이템 획득 횟수
      };

      // 통계 초기화 함수
      function resetStats() {
        logStats = {
          totalOpens: 0,
          items: {},
          grades: { 1: 0, 2: 0, 3: 0, 4: 0 },
          tradeable: { available: 0, unavailable: 0 },
          rareItems: 0
        };
      }

      // 타임스탬프 생성 함수
      function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }

      // 등급별 색상 클래스 반환 함수
      function getGradeColorClass(grade) {
        if (!grade) return 'item-name'; // 등급이 없으면 기본 색상
        return `item-grade-${grade}`;
      }

      // 아이템 이름에서 거래 가능/불가 정보 추출
      function extractTradeInfo(itemName) {
        if (itemName.includes('거래가능')) {
          return { displayName: itemName.replace(/\s*\(거래가능\)/g, ''), tradeStatus: 'available' };
        } else if (itemName.includes('거래 불가') || itemName.includes('거래불가')) {
          return { displayName: itemName.replace(/\s*\(거래\s*불가\)/g, ''), tradeStatus: 'unavailable' };
        }
        return { displayName: itemName, tradeStatus: null };
      }

      // 콘솔에 메시지 추가
      function addConsoleLine(message, isSystem = false, isRare = false, logNumber = null) {
        const consoleContent = document.getElementById('console-content');
        const line = document.createElement('div');
        line.className = 'console-line';
        
        // 희귀 아이템인 경우 특별한 클래스 추가
        if (isRare) {
          line.classList.add('rare-item');
        }
        
        if (isSystem) {
          line.innerHTML = `<span class="timestamp">[시스템]</span><span>${message}</span>`;
        } else {
          // 개봉 순서 번호 추가 (고정 폭으로 포맷팅)
          let numberHtml = '';
          if (logNumber !== null) {
            // 최대 9999개까지 고려하여 4자리로 포맷팅
            const formattedNumber = String(logNumber).padStart(4, ' ');
            numberHtml = `<span class="log-number">#${formattedNumber}</span>`;
          }
          line.innerHTML = numberHtml + message;
        }
        
        consoleContent.appendChild(line);
        
        // 스크롤을 맨 아래로 (DOM 업데이트 후 실행)
        setTimeout(() => {
          const consoleWrapper = document.querySelector('.console-content-wrapper');
          if (consoleWrapper) {
            consoleWrapper.scrollTop = consoleWrapper.scrollHeight;
          }
        }, 0);
      }

      // 총 열기 횟수 카운터
      let totalOpenCount = 0;

      // 카운터 업데이트 함수
      function updateCounter() {
        document.getElementById('total-count').textContent = totalOpenCount.toLocaleString();
      }

      // 상자 선택 함수
      function selectBox(boxId) {
        if (!gachaData) return;
        
        const box = gachaData.boxes.find(b => b.id === boxId);
        if (!box) return;
        
        // 이전 상자와 다른 상자로 변경되는 경우에만 로그 및 카운터 초기화
        if (currentBox && currentBox.id !== boxId) {
          const consoleContent = document.getElementById('console-content');
          consoleContent.innerHTML = '';
          totalOpenCount = 0;
          updateCounter();
          resetStats();
        }
        
        currentBox = box;
        gachaItems = box.items;
        
        // UI 업데이트
        document.getElementById('box-name').textContent = box.name;
        document.getElementById('box-description').textContent = '';
        const boxOpenContainer = document.getElementById('box-open-container');
        boxOpenContainer.style.opacity = '1';
        boxOpenContainer.style.pointerEvents = 'auto';
        
        // 상자 이미지 설정
        const encodedBoxName = encodeURIComponent(box.name + '.webp');
        const imageUrl = `https://media.dsrwiki.com/dsrwiki/item/${encodedBoxName}`;
        const boxImage = document.getElementById('box-image');
        const boxImagePlaceholder = document.getElementById('box-image-placeholder');
        
        // 플레이스홀더 먼저 숨김 (배경만 보이도록)
        boxImage.style.display = 'none';
        boxImagePlaceholder.style.display = 'none';
        
        // 이미지 로드 시도
        const img = new Image();
        img.onload = function() {
          boxImage.src = imageUrl;
          boxImage.style.display = 'block';
          boxImagePlaceholder.style.display = 'none';
        };
        img.onerror = function() {
          boxImage.style.display = 'none';
          boxImagePlaceholder.style.display = 'none'; // 배경만 보이도록
        };
        img.src = imageUrl;
      }

      // 가챠 실행 함수 (단일)
      function executeSingleGacha() {
        if (!currentBox || gachaItems.length === 0) {
          addConsoleLine('먼저 상자를 선택해주세요.', true);
          return null;
        }
        
        // 랜덤 값 생성 (0 ~ 100)
        const random = Math.random() * 100;
        
        // 누적 확률로 아이템 선택
        let cumulativeProbability = 0;
        let selectedItem = null;
        
        for (const item of gachaItems) {
          cumulativeProbability += item.probability;
          if (random <= cumulativeProbability) {
            selectedItem = item;
            break;
          }
        }
        
        // 선택된 아이템이 없으면 마지막 아이템 선택 (오차 보정)
        if (!selectedItem) {
          selectedItem = gachaItems[gachaItems.length - 1];
        }
        
        // 콘솔에 결과 표시 (상자 이름 포함, 등급별 색상 적용)
        const gradeClass = getGradeColorClass(selectedItem.grade);
        const tradeInfo = extractTradeInfo(selectedItem.name);
        
        // 희귀 아이템 판단
        let isRare = false;
        if (currentBox.id === 'gunggeukche') {
          // 궁극체 디지코어 꾸러미는 희귀 효과 없음
          isRare = false;
        } else if (currentBox.id === 'bulmyeol') {
          // 불멸의 우정 상자는 0.7% 이하일 때 희귀 효과
          isRare = selectedItem.probability <= 0.7;
        } else {
          // 나머지 상자는 0.61% 미만일 때 희귀 효과
          isRare = selectedItem.probability < 0.61;
        }
        
        let tradeStatusHtml = '';
        if (tradeInfo.tradeStatus === 'available') {
          tradeStatusHtml = ' <span class="trade-available">(거래가능)</span>';
        } else if (tradeInfo.tradeStatus === 'unavailable') {
          tradeStatusHtml = ' <span class="trade-unavailable">(거래불가)</span>';
        }
        
        // 카운터 증가 (번호는 증가 전 값 사용)
        totalOpenCount++;
        const currentLogNumber = totalOpenCount;
        updateCounter();
        
        const message = `<span style="color: #9cdcfe;">[${currentBox.name}]</span> <span class="${gradeClass}">[${tradeInfo.displayName}]</span> <span class="item-count">${selectedItem.count}개</span>를 획득했습니다.${tradeStatusHtml}`;
        addConsoleLine(message, false, isRare, currentLogNumber);
        
        // 통계 업데이트
        updateStats(selectedItem, tradeInfo, isRare);
        
        return selectedItem;
      }

      // 통계 업데이트 함수
      function updateStats(item, tradeInfo, isRare) {
        logStats.totalOpens++;
        
        // 아이템별 획득 횟수
        const itemKey = item.name;
        if (!logStats.items[itemKey]) {
          logStats.items[itemKey] = {
            count: 0,
            grade: item.grade || 1,
            probability: item.probability || 0,
            displayName: tradeInfo.displayName
          };
        }
        logStats.items[itemKey].count += item.count;
        
        // 등급별 획득 횟수
        const grade = item.grade || 1;
        if (logStats.grades[grade] !== undefined) {
          logStats.grades[grade] += item.count;
        }
        
        // 거래 가능/불가 통계
        if (tradeInfo.tradeStatus === 'available') {
          logStats.tradeable.available += item.count;
        } else if (tradeInfo.tradeStatus === 'unavailable') {
          logStats.tradeable.unavailable += item.count;
        }
        
        // 희귀 아이템 통계
        if (isRare) {
          logStats.rareItems += item.count;
        }
      }

      // 통계 모달 내용 업데이트
      function updateStatsModal() {
        const modalBody = document.getElementById('stats-modal-body');
        
        if (logStats.totalOpens === 0) {
          modalBody.innerHTML = '<div style="text-align: center; color: #9cdcfe; padding: 40px;">아직 개봉한 상자가 없습니다.</div>';
          return;
        }
        
        let html = '';
        
        // 아이템별 상세 통계
        html += '<div class="stats-section">';
        html += '<div class="stats-section-title">아이템별 획득 통계</div>';
        html += '<div class="stats-item-list">';
        
        // 획득 횟수 순으로 정렬
        const sortedItems = Object.entries(logStats.items)
          .sort((a, b) => b[1].count - a[1].count);
        
        sortedItems.forEach(([itemName, itemData]) => {
          const percentage = logStats.totalOpens > 0 ? ((itemData.count / logStats.totalOpens) * 100).toFixed(2) : 0;
          const gradeClass = `item-grade-${itemData.grade}`;
          html += `<div class="stats-item-row">
            <span class="stats-item-name ${gradeClass}">${itemData.displayName}</span>
            <span class="stats-item-count">${itemData.count.toLocaleString()}개</span>
            <span class="stats-item-percentage">${percentage}%</span>
          </div>`;
        });
        
        html += '</div></div>';
        
        modalBody.innerHTML = html;
      }

      // 가챠 일괄 실행 함수
      function executeMultipleGacha(count) {
        if (!currentBox) {
          addConsoleLine('먼저 상자를 선택해주세요.', true);
          return;
        }
        
        if (count <= 0 || count > 1000) {
          addConsoleLine('개수는 1~1000 사이여야 합니다.', true);
          return;
        }

        // 각 상자 열기
        for (let i = 0; i < count; i++) {
          executeSingleGacha();
        }
      }

      // 이벤트 리스너 설정
      document.addEventListener('DOMContentLoaded', async function() {
        // JSON 데이터 로드
        try {
          const response = await fetch('https://media.dsrwiki.com/data/csv/gacha.json');
          gachaData = await response.json();
          
          // 상자 선택 드롭다운 채우기
          const boxSelect = document.getElementById('box-select');
          gachaData.boxes.forEach(box => {
            const option = document.createElement('option');
            option.value = box.id;
            option.textContent = box.name;
            boxSelect.appendChild(option);
          });
          
          // 첫 번째 상자 자동 선택
          if (gachaData.boxes.length > 0) {
            const firstBoxId = gachaData.boxes[0].id;
            boxSelect.value = firstBoxId;
            selectBox(firstBoxId);
          }
          
          // 상자 선택 이벤트
          boxSelect.addEventListener('change', function() {
            if (this.value) {
              selectBox(this.value);
            } else {
              currentBox = null;
              gachaItems = [];
              document.getElementById('box-name').textContent = '상자를 선택하세요';
              document.getElementById('box-description').textContent = '';
              const boxOpenContainer = document.getElementById('box-open-container');
              boxOpenContainer.style.opacity = '0.5';
              boxOpenContainer.style.pointerEvents = 'none';
            }
          });
        } catch (error) {
          console.error('가챠 데이터 로드 실패:', error);
          addConsoleLine('가챠 데이터를 불러오는데 실패했습니다.', true);
        }
        
        // 개봉 수 조절 버튼
        document.getElementById('count-minus-btn').addEventListener('click', function() {
          const countInput = document.getElementById('gacha-count');
          const currentValue = parseInt(countInput.value) || 1;
          if (currentValue > 1) {
            countInput.value = currentValue - 1;
          }
        });
        
        document.getElementById('count-plus-btn').addEventListener('click', function() {
          const countInput = document.getElementById('gacha-count');
          const currentValue = parseInt(countInput.value) || 1;
          if (currentValue < 1000) {
            countInput.value = currentValue + 1;
          }
        });
        
        // 개봉 버튼
        document.getElementById('open-btn').addEventListener('click', function() {
          if (!currentBox) {
            addConsoleLine('먼저 상자를 선택해주세요.', true);
            return;
          }
          const count = parseInt(document.getElementById('gacha-count').value) || 1;
          executeMultipleGacha(count);
        });

        // 엔터키로 개봉
        document.getElementById('gacha-count').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            document.getElementById('open-btn').click();
          }
        });
        
        // 로그 지우기 버튼
        document.getElementById('clear-btn').addEventListener('click', function() {
          const consoleContent = document.getElementById('console-content');
          consoleContent.innerHTML = '';
          // 카운터는 유지
        });

        // 통계 보기 버튼
        document.getElementById('stats-btn').addEventListener('click', function() {
          updateStatsModal();
          document.getElementById('stats-modal').style.display = 'flex';
        });

        // 통계 모달 닫기 버튼
        document.getElementById('stats-modal-close').addEventListener('click', function() {
          document.getElementById('stats-modal').style.display = 'none';
        });

        // 모달 배경 클릭 시 닫기
        document.getElementById('stats-modal').addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });

        // 초기 카운터 표시
        updateCounter();
      });
    </script>
  </body>
</html>

